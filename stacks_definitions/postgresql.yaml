# Configuration PostgreSQL pour WindFlow Marketplace
# PostgreSQL - Syst√®me de gestion de base de donn√©es relationnelle
# https://www.postgresql.org

# ============================================================================
# M√âTADONN√âES DU STACK
# ============================================================================
metadata:
  name: "PostgreSQL Database Server"
  version: "1.0.0"
  category: "Database"
  author: "PostgreSQL Global Development Group"
  license: "PostgreSQL License"
  deployment_name: "{{ container_name }}"
  description: |
    PostgreSQL est un syst√®me de gestion de base de donn√©es relationnelle et objet
    open-source puissant et fiable, reconnu pour sa robustesse et ses fonctionnalit√©s avanc√©es.

    Fonctionnalit√©s principales :
    - Conformit√© ACID compl√®te
    - Support des transactions et des contraintes d'int√©grit√©
    - R√©plication et haute disponibilit√©
    - Extensions riches (PostGIS, pgcrypto, etc.)
    - Types de donn√©es avanc√©s (JSON, XML, Arrays, etc.)
    - Indexation performante (B-tree, Hash, GiST, GIN)
    - Requ√™tes complexes et optimiseur intelligent
    - Support complet de SQL:2016

    Ce stack d√©ploie une instance PostgreSQL standalone pr√™te pour la production
    avec configuration optimis√©e et volumes persistants.

  icon_url: "https://www.postgresql.org/media/img/about/press/elephant.png"
  documentation_url: "https://www.postgresql.org/docs/"

  screenshots:
    - "https://www.postgresql.org/media/img/about/press/elephant.png"

  tags:
    - database
    - postgresql
    - sql
    - relational
    - rdbms
    - postgres

  is_public: true

  # Cible de d√©ploiement : container Docker simple
  target_type: "docker"

# ============================================================================
# PARAMETERS FOR DOCKER (CONTAINER SIMPLE)
# ============================================================================
target_parameters:
  # volume that needs to be destroyed
  #
  volumes:
    - "{{ volume_name }}"


# ============================================================================
# TEMPLATE DOCKER (CONTAINER SIMPLE)
# ============================================================================
template:
  # Image PostgreSQL officielle
  image: "postgres:{{ postgres_version }}"

  # Nom du container
  container_name: "{{ deployment_name }}"

  # Variables d'environnement
  environment:
    POSTGRES_USER: "{{ postgres_user }}"
    POSTGRES_PASSWORD: "{{ postgres_password }}"
    POSTGRES_DB: "{{ database_name }}"
    POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale={{ locale }}"
    PGDATA: "/var/lib/postgresql/data/pgdata"

    # Configuration performance (optionnel)
    POSTGRES_SHARED_BUFFERS: "{{ performance.shared_buffers }}"
    POSTGRES_MAX_CONNECTIONS: "{{ performance.max_connections }}"
    POSTGRES_WORK_MEM: "{{ performance.work_mem }}"

  # Mapping des ports
  ports:
    - "{{ host_port }}:5432"

  # Volumes persistants
  volumes:
    - "{{ volume_name }}:/var/lib/postgresql/data"

  # Politique de red√©marrage
  restart_policy: "unless-stopped"

  # Health check
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U {{ postgres_user }} -d {{ database_name }}"]
    interval: "10s"
    timeout: "5s"
    retries: 5
    start_period: "30s"

  # Labels pour gestion
  labels:
    app: "postgresql"
    managed_by: "windflow"
    stack: "postgresql_docker"
    version: "{{ postgres_version }}"
    deployment_name: "{{ deployment_name }}"

# ============================================================================
# VARIABLES CONFIGURABLES
# ============================================================================
variables:
  # Version PostgreSQL
  postgres_version:
    type: string
    label: "Version PostgreSQL"
    description: "Version de PostgreSQL √† d√©ployer"
    default: "16"
    enum:
      - "16"
      - "15"
      - "14"
      - "13"
      - "12"
      - "latest"
    required: true
    group: "Configuration g√©n√©rale"
    help: "PostgreSQL 16 est la derni√®re version stable recommand√©e"

  # Nom du container
  container_name:
    type: string
    label: "Nom du container"
    description: "Nom unique du container Docker"
    default: "{{generate_animalname('postgres')}}"
    required: true
    visible: false
    pattern: "^[a-zA-Z0-9][a-zA-Z0-9_.-]*$"
    group: "Configuration g√©n√©rale"
    help: "Le nom doit √™tre unique sur l'h√¥te Docker"

  # Configuration base de donn√©es
  database_name:
    type: string
    label: "Nom de la base de donn√©es"
    description: "Nom de la base de donn√©es par d√©faut"
    default: "mydb"
    required: true
    pattern: "^[a-zA-Z_][a-zA-Z0-9_]*$"
    min_length: 1
    max_length: 63
    group: "Configuration base de donn√©es"
    help: "Nom valide PostgreSQL (lettres, chiffres, underscore)"

  # Utilisateur PostgreSQL
  postgres_user:
    type: string
    label: "Utilisateur PostgreSQL"
    description: "Nom de l'utilisateur superadmin"
    default: "postgres"
    required: true
    pattern: "^[a-zA-Z_][a-zA-Z0-9_]*$"
    min_length: 1
    max_length: 63
    group: "Configuration base de donn√©es"

  # Mot de passe
  postgres_password:
    type: password
    label: "Mot de passe PostgreSQL"
    description: "Mot de passe du superadmin (g√©n√©r√© automatiquement si vide)"
    default: "{{ generate_password(24) }}"
    required: true
    min_length: 12
    group: "S√©curit√©"
    help: "Un mot de passe fort de 24 caract√®res sera g√©n√©r√© automatiquement"

  # Locale
  locale:
    type: string
    label: "Locale syst√®me"
    description: "Locale pour l'encodage et le tri des donn√©es"
    default: "en_US.UTF-8"
    enum:
      - "en_US.UTF-8"
      - "fr_FR.UTF-8"
      - "de_DE.UTF-8"
      - "es_ES.UTF-8"
      - "C"
    enum_labels:
      "en_US.UTF-8": "English (United States)"
      "fr_FR.UTF-8": "Fran√ßais (France)"
      "de_DE.UTF-8": "Deutsch (Deutschland)"
      "es_ES.UTF-8": "Espa√±ol (Espa√±a)"
      "C": "C (Default POSIX)"
    required: true
    group: "Configuration base de donn√©es"
    help: "La locale affecte le tri et les comparaisons de cha√Ænes"

  # Port h√¥te
  host_port:
    type: integer
    label: "Port h√¥te"
    description: "Port expos√© sur l'h√¥te Docker pour acc√©der √† PostgreSQL"
    default: "{{get_valid_port(5432)}}"
    minimum: 1
    maximum: 65535
    required: true
    group: "Configuration r√©seau"
    help: "Port standard PostgreSQL : 5432"

  # Volume
  volume_name:
    type: string
    label: "Nom du volume"
    description: "Nom du volume Docker pour la persistance des donn√©es"
    default: "{{generate_cosmicname('postgres-data')}}"
    required: true
    pattern: "^[a-zA-Z0-9][a-zA-Z0-9_.-]*$"
    group: "Stockage"
    help: "Volume Docker nomm√© pour la persistance"

  performance:
    type: group
    label: "Param√®tres de performance"
    variables:
      # Performance - Shared Buffers
      shared_buffers:
        type: string
        label: "Shared Buffers"
        description: "M√©moire partag√©e pour le cache PostgreSQL"
        default: "256MB"
        enum:
          - "128MB"
          - "256MB"
          - "512MB"
          - "1GB"
          - "2GB"
          - "4GB"
        required: false
        group: "Performance"
        help: "Recommand√©: 25% de la RAM disponible"

      # Performance - Max Connections
      max_connections:
        type: integer
        label: "Connexions maximales"
        description: "Nombre maximum de connexions simultan√©es"
        default: 100
        minimum: 10
        maximum: 1000
        required: false
        group: "Performance"
        help: "Ajuster selon les besoins (chaque connexion consomme de la RAM)"

      # Performance - Work Mem
      work_mem:
        type: string
        label: "Work Memory"
        description: "M√©moire allou√©e pour les op√©rations de tri et hash"
        default: "4MB"
        enum:
          - "1MB"
          - "2MB"
          - "4MB"
          - "8MB"
          - "16MB"
          - "32MB"
        required: false
        group: "Performance"
        help: "M√©moire par op√©ration (tri, hash join, etc.)"

# ============================================================================
# NOTES DE D√âPLOIEMENT
# ============================================================================
deployment_notes: |
  ## Notes de d√©ploiement PostgreSQL

  ### üöÄ D√©marrage rapide

  Apr√®s le d√©ploiement, PostgreSQL sera accessible sur le port {{ host_port }}.

  **Connexion depuis l'h√¥te :**
  ```bash
  psql -h localhost -p {{ host_port }} -U {{ postgres_user }} -d {{ database_name }}
  # Mot de passe : (voir les variables de d√©ploiement)
  ```

  **Connexion depuis un autre container :**
  ```bash
  psql -h {{ container_name }} -p 5432 -U {{ postgres_user }} -d {{ database_name }}
  ```

  ### üì¶ Volumes et persistance

  Les donn√©es PostgreSQL sont stock√©es dans le volume Docker nomm√© : `{{ volume_name }}`

  **Localisation du volume :**
  ```bash
  docker volume inspect {{ volume_name }}
  ```

  **Sauvegarde manuelle :**
  ```bash
  # Dump de toutes les bases
  docker exec {{ container_name }} pg_dumpall -U {{ postgres_user }} > backup_all.sql

  # Dump d'une base sp√©cifique
  docker exec {{ container_name }} pg_dump -U {{ postgres_user }} {{ database_name }} > backup.sql

  # Dump avec compression
  docker exec {{ container_name }} pg_dump -U {{ postgres_user }} -Fc {{ database_name }} > backup.dump
  ```

  **Restauration :**
  ```bash
  # Depuis un dump SQL
  cat backup.sql | docker exec -i {{ container_name }} psql -U {{ postgres_user }} {{ database_name }}

  # Depuis un dump compress√©
  docker exec -i {{ container_name }} pg_restore -U {{ postgres_user }} -d {{ database_name }} < backup.dump
  ```

  ### üîí S√©curit√©

  **Mots de passe g√©n√©r√©s automatiquement :**
  - Le mot de passe PostgreSQL est g√©n√©r√© avec 24 caract√®res al√©atoires
  - Conservez-le dans un gestionnaire de mots de passe s√©curis√©

  **Recommandations de s√©curit√© :**
  1. Ne pas exposer le port 5432 publiquement (utiliser un reverse proxy)
  2. Utiliser des connexions SSL/TLS en production
  3. Configurer pg_hba.conf pour restreindre les acc√®s
  4. Cr√©er des utilisateurs avec privil√®ges limit√©s

  **Cr√©er un utilisateur avec privil√®ges limit√©s :**
  ```sql
  -- Connexion en tant que superadmin
  CREATE USER myapp_user WITH PASSWORD 'secure_password';
  CREATE DATABASE myapp_db OWNER myapp_user;
  GRANT ALL PRIVILEGES ON DATABASE myapp_db TO myapp_user;
  ```

  ### ‚ö° Performance

  **Configuration actuelle :**
  - Shared Buffers: {{ shared_buffers }}
  - Max Connections: {{ max_connections }}
  - Work Memory: {{ work_mem }}

  **Optimisations recommand√©es :**

  Pour **usage l√©ger** (< 2GB RAM) :
  - shared_buffers: 128MB
  - max_connections: 50
  - work_mem: 2MB

  Pour **usage moyen** (4-8GB RAM) :
  - shared_buffers: 512MB - 1GB
  - max_connections: 100
  - work_mem: 4MB

  Pour **usage intensif** (16GB+ RAM) :
  - shared_buffers: 2GB - 4GB
  - max_connections: 200
  - work_mem: 8MB - 16MB

  **Monitoring des performances :**
  ```sql
  -- Connexions actives
  SELECT count(*) FROM pg_stat_activity;

  -- Taille des bases de donn√©es
  SELECT pg_database.datname, pg_size_pretty(pg_database_size(pg_database.datname))
  FROM pg_database;

  -- Requ√™tes lentes
  SELECT pid, now() - pg_stat_activity.query_start AS duration, query
  FROM pg_stat_activity
  WHERE state = 'active'
  ORDER BY duration DESC;
  ```

  ### üîß Maintenance

  **Logs PostgreSQL :**
  ```bash
  # Afficher les logs en temps r√©el
  docker logs -f {{ container_name }}

  # Derni√®res 100 lignes
  docker logs --tail 100 {{ container_name }}
  ```

  **V√©rification de la sant√© :**
  ```bash
  # Health check manuel
  docker exec {{ container_name }} pg_isready -U {{ postgres_user }}

  # Statistiques du container
  docker stats {{ container_name }}
  ```

  **Op√©rations de maintenance :**
  ```sql
  -- VACUUM pour nettoyer les lignes mortes
  VACUUM ANALYZE;

  -- R√©indexation
  REINDEX DATABASE {{ database_name }};

  -- Statistiques des tables
  SELECT schemaname, tablename, n_live_tup, n_dead_tup
  FROM pg_stat_user_tables
  ORDER BY n_dead_tup DESC;
  ```

  ### üìä Ressources recommand√©es

  **Minimum (d√©veloppement) :**
  - CPU : 1 core
  - RAM : 512 MB
  - Disque : 1 GB

  **Recommand√© (production l√©g√®re) :**
  - CPU : 2 cores
  - RAM : 2-4 GB
  - Disque : 10 GB SSD

  **Production intensive :**
  - CPU : 4+ cores
  - RAM : 8-16 GB
  - Disque : 50+ GB SSD avec IOPS √©lev√©s

  ### üîå Extensions populaires

  ```sql
  -- Activer des extensions utiles
  CREATE EXTENSION IF NOT EXISTS "uuid-ossp";      -- G√©n√©ration UUID
  CREATE EXTENSION IF NOT EXISTS "pg_trgm";        -- Recherche floue
  CREATE EXTENSION IF NOT EXISTS "pgcrypto";       -- Fonctions crypto
  CREATE EXTENSION IF NOT EXISTS "hstore";         -- Type cl√©-valeur

  -- Lister les extensions disponibles
  SELECT * FROM pg_available_extensions ORDER BY name;

  -- Lister les extensions actives
  SELECT * FROM pg_extension;
  ```

  ### üåê Connexions depuis applications

  **Connection strings :**

  Python (psycopg2) :
  ```python
  import psycopg2
  conn = psycopg2.connect(
      host="localhost",
      port={{ host_port }},
      database="{{ database_name }}",
      user="{{ postgres_user }}",
      password="<your_password>"
  )
  ```

  Node.js (pg) :
  ```javascript
  const { Client } = require('pg');
  const client = new Client({
    host: 'localhost',
    port: {{ host_port }},
    database: '{{ database_name }}',
    user: '{{ postgres_user }}',
    password: '<your_password>'
  });
  ```

  Java (JDBC) :
  ```java
  String url = "jdbc:postgresql://localhost:{{ host_port }}/{{ database_name }}";
  Connection conn = DriverManager.getConnection(url, "{{ postgres_user }}", "<password>");
  ```

  ### üìö Support et documentation

  - Documentation officielle : https://www.postgresql.org/docs/
  - Wiki PostgreSQL : https://wiki.postgresql.org/
  - Communaut√© : https://www.postgresql.org/community/
  - Stack Overflow : https://stackoverflow.com/questions/tagged/postgresql

  ### ‚ö†Ô∏è Avertissements

  1. **Premier d√©marrage** : L'initialisation peut prendre 30-60 secondes
  2. **Changement de version** : Ne pas changer de version majeure sans migration appropri√©e
  3. **Backup** : Toujours effectuer des sauvegardes avant les mises √† jour
  4. **Production** : Consid√©rer un setup haute disponibilit√© avec r√©plication

  ---

  **WindFlow** - D√©ploiement intelligent de containers Docker
