# Scanner de Vuln√©rabilit√©s

[‚Üê Auto-Updates](06-AUTO-UPDATES.md) | [Suivant : Hawser Proxy ‚Üí](08-HAWSER-PROXY.md)

## üõ°Ô∏è Vue d'ensemble

Int√©gration de scanners de vuln√©rabilit√©s (Grype et Trivy) pour analyser les images Docker.

## 1. Scanner Abstrait

```python
# scanning/base.py
from abc import ABC, abstractmethod
from typing import Dict, List
from dataclasses import dataclass

@dataclass
class Vulnerability:
    id: str
    severity: str  # Critical, High, Medium, Low, Negligible
    package: str
    version: str
    fixed_version: str = None
    description: str = ""
    cvss: float = 0.0

@dataclass
class ScanResult:
    image: str
    scanner: str
    vulnerabilities: List[Vulnerability]
    critical_count: int = 0
    high_count: int = 0
    medium_count: int = 0
    low_count: int = 0
    duration_seconds: int = 0
    error: str = None

class VulnerabilityScanner(ABC):
    """Scanner de vuln√©rabilit√©s abstrait"""
    
    @abstractmethod
    async def scan(self, image_name: str, env_id: int = None) -> ScanResult:
        """Scanner une image"""
        pass
    
    @abstractmethod
    async def is_available(self) -> bool:
        """V√©rifier si le scanner est disponible"""
        pass
```

## 2. Scanner Grype

```python
# scanning/grype.py
import json
import asyncio

class GrypeScanner(VulnerabilityScanner):
    """Scanner Grype d'Anchore"""
    
    GRYPE_IMAGE = "anchore/grype:latest"
    
    def __init__(self, docker_client):
        self.docker = docker_client
    
    async def scan(self, image_name: str, env_id: int = None) -> ScanResult:
        """Scanner une image avec Grype"""
        import time
        start = time.time()
        
        # Ex√©cuter Grype dans un conteneur
        output = await self.docker.run_container({
            "image": self.GRYPE_IMAGE,
            "cmd": ["-o", "json", image_name],
            "volume_binds": ["/var/run/docker.sock:/var/run/docker.sock"],
            "auto_remove": True
        }, env_id)
        
        # Parser le r√©sultat JSON
        result = json.loads(output)
        
        vulnerabilities = []
        counts = {"Critical": 0, "High": 0, "Medium": 0, "Low": 0}
        
        for match in result.get("matches", []):
            vuln = match.get("vulnerability", {})
            artifact = match.get("artifact", {})
            
            severity = vuln.get("severity", "Unknown")
            
            vulnerabilities.append(Vulnerability(
                id=vuln.get("id", ""),
                severity=severity,
                package=artifact.get("name", ""),
                version=artifact.get("version", ""),
                fixed_version=match.get("fix", {}).get("versions", [""])[0] if match.get("fix") else None,
                description=vuln.get("description", ""),
                cvss=max([d.get("baseScore", 0) for d in vuln.get("cvss", [])], default=0)
            ))
            
            if severity in counts:
                counts[severity] += 1
        
        return ScanResult(
            image=image_name,
            scanner="grype",
            vulnerabilities=vulnerabilities,
            critical_count=counts["Critical"],
            high_count=counts["High"],
            medium_count=counts["Medium"],
            low_count=counts["Low"],
            duration_seconds=int(time.time() - start)
        )
    
    async def is_available(self) -> bool:
        """V√©rifier si l'image Grype est disponible"""
        try:
            await self.docker.inspect_image(self.GRYPE_IMAGE)
            return True
        except:
            return False
```

## 3. Scanner Trivy

```python
# scanning/trivy.py
import json

class TrivyScanner(VulnerabilityScanner):
    """Scanner Trivy d'Aqua Security"""
    
    TRIVY_IMAGE = "aquasec/trivy:latest"
    
    def __init__(self, docker_client):
        self.docker = docker_client
    
    async def scan(self, image_name: str, env_id: int = None) -> ScanResult:
        """Scanner une image avec Trivy"""
        import time
        start = time.time()
        
        output = await self.docker.run_container({
            "image": self.TRIVY_IMAGE,
            "cmd": ["image", "--format", "json", image_name],
            "volume_binds": [
                "/var/run/docker.sock:/var/run/docker.sock",
                "trivy-cache:/root/.cache/trivy"
            ],
            "auto_remove": True
        }, env_id)
        
        result = json.loads(output)
        
        vulnerabilities = []
        counts = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0}
        
        for finding in result.get("Results", []):
            for vuln in finding.get("Vulnerabilities", []):
                severity = vuln.get("severity", "UNKNOWN")
                
                vulnerabilities.append(Vulnerability(
                    id=vuln.get("VulnerabilityID", ""),
                    severity=severity.capitalize(),
                    package=vuln.get("PkgName", ""),
                    version=vuln.get("InstalledVersion", ""),
                    fixed_version=vuln.get("FixedVersion"),
                    description=vuln.get("Description", ""),
                    cvss=vuln.get("CVSS", {}).get("nvd", {}).get("V3Score", 0)
                ))
                
                if severity in counts:
                    counts[severity] += 1
        
        return ScanResult(
            image=image_name,
            scanner="trivy",
            vulnerabilities=vulnerabilities,
            critical_count=counts["CRITICAL"],
            high_count=counts["HIGH"],
            medium_count=counts["MEDIUM"],
            low_count=counts["LOW"],
            duration_seconds=int(time.time() - start)
        )
    
    async def is_available(self) -> bool:
        try:
            await self.docker.inspect_image(self.TRIVY_IMAGE)
            return True
        except:
            return False
```

## 4. Manager de Scanner

```python
# scanning/manager.py
from typing import Optional

class ScannerManager:
    """Gestionnaire de scanners"""
    
    def __init__(self, docker_client):
        self.scanners = {
            "grype": GrypeScanner(docker_client),
            "trivy": TrivyScanner(docker_client)
        }
        self._preferred = None
    
    async def get_available_scanner(self) -> Optional[str]:
        """Obtenir le premier scanner disponible"""
        if self._preferred:
            scanner = self.scanners.get(self._preferred)
            if scanner and await scanner.is_available():
                return self._preferred
        
        for name, scanner in self.scanners.items():
            if await scanner.is_available():
                self._preferred = name
                return name
        
        return None
    
    async def scan(self, image_name: str, scanner_name: str = None, env_id: int = None) -> ScanResult:
        """Scanner une image"""
        if not scanner_name:
            scanner_name = await self.get_available_scanner()
        
        if not scanner_name:
            raise Exception("No scanner available. Pull grype or trivy image first.")
        
        scanner = self.scanners.get(scanner_name)
        if not scanner:
            raise ValueError(f"Unknown scanner: {scanner_name}")
        
        return await scanner.scan(image_name, env_id)
```

## 5. API Routes

```python
from fastapi import APIRouter

router = APIRouter(prefix="/api/scans", tags=["scans"])

@router.post("/images/{image_id}")
async def scan_image(
    image_id: str,
    scanner: str = Query(None),
    env_id: int = Query(None),
    user = Depends(require_permission("images:scan"))
):
    """Scanner une image"""
    manager = ScannerManager(docker_client)
    
    # R√©cup√©rer le nom de l'image
    image = await docker_client.inspect_image(image_id, env_id)
    image_name = image.get("RepoTags", [image_id])[0]
    
    result = await manager.scan(image_name, scanner, env_id)
    
    # Sauvegarder en DB
    await save_scan_result(result, env_id)
    
    return {
        "image": result.image,
        "scanner": result.scanner,
        "critical": result.critical_count,
        "high": result.high_count,
        "medium": result.medium_count,
        "low": result.low_count,
        "duration": result.duration_seconds,
        "vulnerabilities": [
            {"id": v.id, "severity": v.severity, "package": v.package, "fixed": v.fixed_version}
            for v in result.vulnerabilities[:100]  # Limit
        ]
    }
```

---

[‚Üê Auto-Updates](06-AUTO-UPDATES.md) | [Suivant : Hawser Proxy ‚Üí](08-HAWSER-PROXY.md)
